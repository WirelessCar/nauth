# This manifest sets up NATS accounts for the `ns1` namespace which contains a JetStream `stream-a`
# The JS API:s for this stream are exported in order to demonstrate a cross-account scenario using NAuth & NACK.

apiVersion: v1
kind: Namespace
metadata:
  name: ns1

---
apiVersion: jetstream.nats.io/v1beta2
kind: Account
metadata:
  name: ns1
  namespace: ns1
spec:
  name: ns1
  creds:
    file: user.creds
    secret:
      name: nack-nats-user-creds

---
apiVersion: nauth.io/v1alpha1
kind: Account
metadata:
  name: ns1
  annotations:
    argocd.argoproj.io/sync-options: Prune=false
spec:
  accountLimits:
    conn: 100
    exports: 100
    imports: 100
  jetStreamLimits:
    consumer: 50
    diskMaxStreamBytes: 209715200
    diskStorage: 209715200
    maxAckPending: -1
    maxBytesRequired: true
    memMaxStreamBytes: 209715200
    memStorage: 209715200
    streams: 50
  natsLimits:
    data: 1024000
    payload: 50000
    subs: 100
  exports:
    - name: ns2-stream-a-data
      subject: ns1.ns2.stream-a.S.>
      type: stream
    - name: ns2-stream-a-flow-control
      subject: $JS.FC.ns1.ns2.stream-a.>
      type: service
    - name: stream-a-consumer-api
      subject: $JS.API.CONSUMER.CREATE.stream-a
      responseType: Stream
      type: service
    - name: stream-a-consumer-api-wild
      subject: $JS.API.CONSUMER.CREATE.stream-a.>
      responseType: Stream
      type: service

---
apiVersion: jetstream.nats.io/v1beta2
kind: Stream
metadata:
  name: stream-a
spec:
  account: ns1
  name: stream-a
  subjects:
    - test.>
  storage: "file"
  replicas: 1
  maxBytes: 10000000
  maxMsgs: 10000

---
# These are the required permissions in order for NACK to be able to reconcile CR:s properly
apiVersion: nauth.io/v1alpha1
kind: User
metadata:
  name: nack
spec:
  accountName: ns1
  permissions:
    pub:
      allow:
        - $JS.API.STREAM.INFO.>
        - $JS.API.STREAM.CREATE.>
        - $JS.API.STREAM.UPDATE.>
        - $JS.API.STREAM.DELETE.>
        - $JS.API.CONSUMER.INFO.>
        - $JS.API.CONSUMER.CREATE.>
        - $JS.API.CONSUMER.UPDATE.>
        - $JS.API.CONSUMER.DELETE.>
        - $JS.API.INFO
    sub:
      allow:
        - _INBOX.>

---
apiVersion: nauth.io/v1alpha1
kind: User
metadata:
  name: myuser
spec:
  accountName: ns1
